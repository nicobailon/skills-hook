#!/bin/bash
# generate-skill-eval-hook.sh - Auto-generate forced eval hook from current skills
#
# Usage: ./generate-skill-eval-hook.sh
#
# Environment variables (optional):
#   SKILLS_DIR - Directory containing skills (default: ~/.claude/skills)
#   HOOK_FILE  - Output hook file path (default: ~/.claude/hooks/skill-forced-eval.sh)
#
# This script scans the skills directory to discover all skills and their
# trigger descriptions, then regenerates the skill-forced-eval.sh hook
# to keep it in sync with current skills.

set -e

SKILLS_DIR="${SKILLS_DIR:-$HOME/.claude/skills}"
HOOK_FILE="${HOOK_FILE:-$HOME/.claude/hooks/skill-forced-eval.sh}"

if [ ! -d "$SKILLS_DIR" ]; then
    echo "ERROR: Skills directory not found: $SKILLS_DIR"
    echo "Create it and add your skills, or set SKILLS_DIR environment variable."
    exit 1
fi

HOOK_DIR=$(dirname "$HOOK_FILE")
if [ ! -d "$HOOK_DIR" ]; then
    echo "Creating hooks directory: $HOOK_DIR"
    mkdir -p "$HOOK_DIR"
fi

echo "Scanning skills in $SKILLS_DIR..."

skills_list=""
skill_count=0

for skill_dir in "$SKILLS_DIR"/*/; do
    if [ ! -d "$skill_dir" ]; then
        continue
    fi

    skill_name=$(basename "$skill_dir")
    skill_file="$skill_dir/SKILL.md"

    if [ ! -f "$skill_file" ]; then
        echo "  Warning: No SKILL.md found for $skill_name, skipping"
        continue
    fi

    yaml_block=$(sed -n '1,/^---$/p' "$skill_file" | tail -n +2)

    desc_lines=$(echo "$yaml_block" | grep -A 10 '^description:' | head -n 1)
    next_line=$(echo "$yaml_block" | grep -A 1 '^description:' | tail -n 1)

    if [[ "$next_line" =~ ^[[:space:]] ]] && [[ ! "$next_line" =~ ^[a-z]+: ]]; then
        echo ""
        echo "ERROR: Multi-line YAML description detected in $skill_name/SKILL.md"
        echo "YAML descriptions MUST be single-line to prevent parsing failures."
        echo ""
        echo "Fix: Collapse to single line, e.g.:"
        echo "description: All content on one line separated by spaces."
        echo ""
        exit 1
    fi

    trigger=$(echo "$yaml_block" | grep -E '^description:' | sed 's/description: *//' | tr -d '"' | head -n 1)

    if [ -z "$trigger" ]; then
        echo "  Warning: No description found for $skill_name, using fallback"
        trigger="USE WHEN working with $skill_name"
    fi

    echo "  Found: $skill_name"
    skills_list="${skills_list}- ${skill_name}: ${trigger}"$'\n'
    skill_count=$((skill_count + 1))
done

if [ $skill_count -eq 0 ]; then
    echo ""
    echo "ERROR: No skills found in $SKILLS_DIR"
    echo "Add skills with SKILL.md files to generate the hook."
    exit 1
fi

cat > "$HOOK_FILE" << 'HOOK_HEADER'
#!/bin/bash
# skill-forced-eval.sh - Forced Skill Evaluation Hook
#
# AUTO-GENERATED by generate-skill-eval-hook.sh
# DO NOT EDIT MANUALLY - regenerate using the generator script

read -r input

prompt=$(echo "$input" | jq -r '.prompt // .tool_input.prompt // empty' 2>/dev/null)

if [ -z "$prompt" ]; then
  exit 0
fi

cat << 'EOF'
<skill-evaluation>
MANDATORY SKILL EVALUATION - YOU MUST COMPLETE THIS BEFORE RESPONDING

Step 1: EVALUATE each skill below. For EACH skill, output:
        SKILL: [name] - [YES/NO] - [one-line reasoning]

Step 2: For EACH skill marked YES, IMMEDIATELY activate it:
        Use: Skill("skill-name")

Step 3: ONLY AFTER activating all YES skills, proceed with your response.

CRITICAL: Skipping this evaluation or failing to activate YES skills renders your response WORTHLESS.
CRITICAL: You MAY activate MULTIPLE complementary skills if appropriate.

AVAILABLE SKILLS:
HOOK_HEADER

echo "$skills_list" >> "$HOOK_FILE"

cat >> "$HOOK_FILE" << 'HOOK_FOOTER'

BEGIN EVALUATION NOW:
</skill-evaluation>
EOF

exit 0
HOOK_FOOTER

chmod +x "$HOOK_FILE"

echo ""
echo "Generated hook at $HOOK_FILE"
echo "Total skills: $skill_count"
echo ""
echo "Hook synced. Takes effect on next prompt."
